"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const koishi_core_1 = require("koishi-core");
const infoFields = new Set(['authority']);
const infoList = [];
function registerUserInfo(callback, fields = [], order = 0) {
    const index = infoList.findIndex(a => a.order > order);
    if (index >= 0) {
        infoList.splice(index, 0, { order, callback });
    }
    else {
        infoList.push({ order, callback });
    }
    for (const field of fields) {
        infoFields.add(field);
    }
}
exports.registerUserInfo = registerUserInfo;
const defaultConfig = {
    getUserName(user, meta) {
        if (meta.userId === user.id && meta.sender) {
            return meta.sender.card || meta.sender.nickname;
        }
    },
};
function apply(ctx, config = {}) {
    config = { ...defaultConfig, ...config };
    ctx.command('info', '查看用户信息', { authority: 0 })
        .alias('i')
        .shortcut('我的信息')
        .option('-u, --user [target]', '指定目标', { authority: 3 })
        .action(async ({ meta, options }) => {
        let user;
        const output = [];
        if (options.user) {
            const id = koishi_core_1.getTargetId(options.user);
            if (!id)
                return meta.$send('未找到用户。');
            user = await ctx.database.getUser(id, -1, Array.from(infoFields));
            if (!user)
                return meta.$send('未找到用户。');
            const name = config.getUserName(user, meta);
            if (!name) {
                output.push(`${id} 的权限为 ${user.authority} 级。`);
            }
            else {
                output.push(`${name} (${id}) 的权限为 ${user.authority} 级。`);
            }
        }
        else {
            user = await ctx.database.getUser(meta.userId, Array.from(infoFields));
            output.push(`${config.getUserName(user, meta) || meta.userId}，您的权限为 ${user.authority} 级。`);
        }
        for (const { callback } of infoList) {
            const result = callback(user);
            if (result)
                output.push(result);
        }
        return meta.$send(output.join('\n'));
    });
}
exports.default = apply;
